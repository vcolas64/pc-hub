<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeu Atomes et Mol√©cules - 4√®me</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .rgpd {
            text-align: center;
            font-size: 0.85em;
            color: #666;
            margin-bottom: 25px;
            font-style: italic;
        }

        .menu {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 20px;
        }

        .mode-selection, .level-selection {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            padding: 15px 25px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #48bb78;
            color: white;
        }

        .btn-secondary:hover {
            background: #38a169;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-locked {
            background: #cbd5e0;
            color: #718096;
            cursor: not-allowed;
            position: relative;
        }

        .btn-locked:hover {
            transform: none;
            box-shadow: none;
        }

        .locked-message {
            font-size: 0.85em;
            color: #e53e3e;
            margin-top: 10px;
            text-align: center;
        }

        .game-area {
            display: none;
            margin-top: 30px;
        }

        .game-area.active {
            display: block;
        }

        .question-container {
            background: #f7fafc;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .question {
            font-size: 1.4em;
            color: #2d3748;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 600;
        }

        .formula {
            font-size: 2em;
            text-align: center;
            margin: 25px 0;
            color: #1a202c;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .molecule-display {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 30px 0;
            flex-wrap: wrap;
            gap: 40px;
        }

        .molecule-group {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }

        .option {
            background: white;
            border: 3px solid #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .option:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }

        .option.selected {
            border-color: #667eea;
            background: #edf2f7;
        }

        .option.correct {
            border-color: #48bb78;
            background: #c6f6d5;
        }

        .option.incorrect {
            border-color: #f56565;
            background: #fed7d7;
        }

        .input-answer {
            padding: 15px;
            font-size: 1.3em;
            border: 3px solid #e2e8f0;
            border-radius: 10px;
            text-align: center;
            width: 150px;
            margin: 20px auto;
            display: block;
        }

        .feedback {
            margin: 25px 0;
            padding: 20px;
            border-radius: 10px;
            font-size: 1.1em;
            display: none;
        }

        .feedback.show {
            display: block;
        }

        .feedback.correct {
            background: #c6f6d5;
            color: #22543d;
            border: 2px solid #48bb78;
        }

        .feedback.incorrect {
            background: #fed7d7;
            color: #742a2a;
            border: 2px solid #f56565;
        }

        .correction {
            background: #fff5f5;
            border: 3px solid #fc8181;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 1.05em;
        }

        .correction h3 {
            color: #c53030;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .correction p {
            margin: 8px 0;
            line-height: 1.6;
        }

        .stats {
            background: #edf2f7;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-size: 1.1em;
        }

        .progress-bar {
            background: #e2e8f0;
            height: 25px;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            background: linear-gradient(90deg, #48bb78, #38a169);
            height: 100%;
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        canvas {
            border-radius: 10px;
        }

        .atom {
            display: inline-block;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2), inset 0 -3px 5px rgba(0,0,0,0.2);
        }

        .atom-H { background: radial-gradient(circle at 30% 30%, #ffffff, #e0e0e0); }
        .atom-O { background: radial-gradient(circle at 30% 30%, #ff6b6b, #c92a2a); }
        .atom-C { background: radial-gradient(circle at 30% 30%, #4a4a4a, #1a1a1a); }
        .atom-N { background: radial-gradient(circle at 30% 30%, #4dabf7, #1971c2); }
        .atom-Co { background: radial-gradient(circle at 30% 30%, #cc99ff, #9933ff); }
        .atom-Cl { background: radial-gradient(circle at 30% 30%, #7fdb7f, #2eb82e); }
        .atom-Ca { background: radial-gradient(circle at 30% 30%, #ffa94d, #ff8000); }

        .molecule {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin: 10px;
        }

        /* M√©thane CH‚ÇÑ - forme en + */
        .molecule-ch4 {
            display: grid;
            grid-template-columns: 40px 40px 40px;
            grid-template-rows: 40px 40px 40px;
            gap: 0;
        }

        .molecule-ch4 .atom-C {
            grid-column: 2;
            grid-row: 2;
        }

        .molecule-ch4 .h1 { grid-column: 2; grid-row: 1; }
        .molecule-ch4 .h2 { grid-column: 3; grid-row: 2; }
        .molecule-ch4 .h3 { grid-column: 2; grid-row: 3; }
        .molecule-ch4 .h4 { grid-column: 1; grid-row: 2; }

        /* Dioxyde de carbone CO‚ÇÇ - lin√©aire O-C-O */
        .molecule-co2 {
            display: flex;
            flex-direction: row;
            gap: 0;
        }

       /* Eau H‚ÇÇO - atomes vraiment coll√©s (positionnement absolu) */
		.molecule-h2o{
			position: relative;
			width: 78px;   /* largeur du "bloc mol√©cule" */
			height: 64px;  /* hauteur du "bloc mol√©cule" */
		}

		.molecule-h2o .atom{
			position: absolute;
		}

		/* O en bas, centr√© */
		.molecule-h2o .atom-O{
			left: 19px;   /* (78-40)/2 */
			top: 22px;
		}

		/* H en haut √† gauche/droite, avec chevauchement l√©ger */
		.molecule-h2o .h1{
			left: -10px;
			top: 0px;
		}
		.molecule-h2o .h2{
			left: 48px;
			top: 0px;
		}



        /* Mol√©cules lin√©aires simples (2 atomes) */
        .molecule-linear {
            display: flex;
            flex-direction: row;
            gap: 0;
        }

        /* Mol√©cule N‚ÇÇO - lin√©aire N-N-O */
        .molecule-n2o {
            display: flex;
            flex-direction: row;
            gap: 0;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.5em;
            }

            .formula {
                font-size: 1.5em;
            }

            .atom {
                width: 35px;
                height: 35px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Atomes et Mol√©cules</h1>
        <p class="rgpd">Ce jeu ne collecte aucune donn√©e personnelle et ne n√©cessite aucune inscription.</p>

        <div id="menu" class="menu">
            <div>
                <h2 style="text-align: center; margin-bottom: 15px;">Choisis un mode de jeu :</h2>
                <div class="mode-selection">
                    <button class="btn-primary" onclick="selectMode(1)">üìù Formule ‚Üí Mod√®le</button>
                    <button class="btn-primary" onclick="selectMode(2)">üî¢ Compter les atomes</button>
                    <button class="btn-primary" onclick="selectMode(3)">‚ùì Atome ou Mol√©cule ?</button>
                </div>
            </div>

            <div id="level-selector" style="display: none;">
                <h2 style="text-align: center; margin-bottom: 15px;">Choisis un niveau :</h2>
                <div class="level-selection">
                    <button class="btn-secondary" onclick="startGame('beginner')">üå± D√©butant</button>
                    <button class="btn-secondary" onclick="startGame('medium')">‚≠ê Moyen</button>
                    <button class="btn-secondary" id="expert-btn" onclick="startGame('expert')">üèÜ Expert</button>
                </div>
                <div id="locked-message" class="locked-message" style="display: none;"></div>
            </div>
        </div>

        <div id="game-area" class="game-area">
            <div class="stats">
                <div><strong>Mode :</strong> <span id="mode-name"></span> | <strong>Niveau :</strong> <span id="level-name"></span></div>
                <div><strong>Question :</strong> <span id="question-number">1</span>/10</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%">0%</div>
                </div>
            </div>

            <div class="question-container">
                <div id="question-content"></div>
                <div id="feedback" class="feedback"></div>
                <div class="controls">
                    <button class="btn-secondary" id="submit-btn" onclick="checkAnswer()" style="display: none;">Valider</button>
                    <button class="btn-primary" id="next-btn" onclick="nextQuestion()" style="display: none;">Question suivante</button>
                    <button class="btn-danger" onclick="quitGame()">Quitter</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Donn√©es scientifiques
        const MOLECULES = {
            'H‚ÇÇO': { atoms: { H: 2, O: 1 }, name: 'eau' },
            'CO‚ÇÇ': { atoms: { C: 1, O: 2 }, name: 'dioxyde de carbone' },
            'O‚ÇÇ': { atoms: { O: 2 }, name: 'dioxyg√®ne' },
            'H‚ÇÇ': { atoms: { H: 2 }, name: 'dihydrog√®ne' },
            'N‚ÇÇ': { atoms: { N: 2 }, name: 'diazote' },
            'CH‚ÇÑ': { atoms: { C: 1, H: 4 }, name: 'm√©thane' },
            'N‚ÇÇO': { atoms: { N: 2, O: 1 }, name: 'protoxyde d\'azote' }
        };

        const ATOMS = ['H', 'O', 'C', 'N'];
        const ATOMS_MODE3 = ['H', 'O', 'C', 'N', 'Co', 'Cl', 'Ca'];
        const MOLECULE_MODE3 = 'CO';

        const ATOM_NAMES = {
            H: 'hydrog√®ne',
            O: 'oxyg√®ne',
            C: 'carbone',
            N: 'azote',
            Co: 'cobalt',
            Cl: 'chlore',
            Ca: 'calcium'
        };

        // Expression correcte : d‚Äôoxyg√®ne / d‚Äôhydrog√®ne / d‚Äôazote / de carbone / etc.
        function atomPhrase(atomSymbol) {
            const name = ATOM_NAMES[atomSymbol] || atomSymbol;
            const first = (name.trim().toLowerCase()[0] || '');
            const vowels = new Set(['a','e','i','o','u','y','h','√†','√¢','√§','√©','√®','√™','√´','√Æ','√Ø','√¥','√∂','√π','√ª','√º']);
            const prep = vowels.has(first) ? "d‚Äô" : "de ";
            return prep + name;
        }

        // √âtat du jeu
        let currentMode = 1;
        let currentLevel = 'beginner';
        let questionNumber = 0;
        let correctAnswers = 0;
        let currentQuestion = null;
        let answered = false;
        let askedQuestions = []; // Historique des questions pos√©es

        // V√©rifier les niveaux d√©bloqu√©s
        function checkUnlockedLevels() {
            const unlocked = JSON.parse(localStorage.getItem('unlockedLevels') || '{}');
            return unlocked;
        }

        function unlockExpertLevel(mode) {
            const unlocked = checkUnlockedLevels();
            unlocked[`mode${mode}`] = true;
            localStorage.setItem('unlockedLevels', JSON.stringify(unlocked));
        }

        function isExpertUnlocked(mode) {
            const unlocked = checkUnlockedLevels();
            return unlocked[`mode${mode}`] === true;
        }

        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('level-selector').style.display = 'block';
            
            const expertBtn = document.getElementById('expert-btn');
            const lockedMsg = document.getElementById('locked-message');
            
            if (isExpertUnlocked(mode)) {
                expertBtn.className = 'btn-secondary';
                expertBtn.disabled = false;
                expertBtn.innerHTML = 'üèÜ Expert';
                lockedMsg.style.display = 'none';
            } else {
                expertBtn.className = 'btn-locked';
                expertBtn.disabled = true;
                expertBtn.innerHTML = 'üîí Expert';
                lockedMsg.style.display = 'block';
                lockedMsg.textContent = 'Termine le niveau Moyen avec au moins 70% de bonnes r√©ponses pour d√©bloquer ce niveau !';
            }
        }

        function startGame(level) {
            if (level === 'expert' && !isExpertUnlocked(currentMode)) {
                return;
            }

            currentLevel = level;
            questionNumber = 0;
            correctAnswers = 0;
            askedQuestions = []; // R√©initialiser l'historique
            
            document.getElementById('menu').style.display = 'none';
            document.getElementById('game-area').classList.add('active');
            
            const modeNames = ['', 'Formule ‚Üí Mod√®le', 'Compter les atomes', 'Atome ou Mol√©cule ?'];
            const levelNames = { beginner: 'D√©butant', medium: 'Moyen', expert: 'Expert' };
            
            document.getElementById('mode-name').textContent = modeNames[currentMode];
            document.getElementById('level-name').textContent = levelNames[level];
            
            nextQuestion();
        }

        function getMaxCoefficient() {
            if (currentLevel === 'beginner') return 3;
            if (currentLevel === 'medium') return 10;
            return 20;
        }

        // Fonction pour comparer deux ensembles de parts
        function arePartsEqual(parts1, parts2) {
            if (parts1.length !== parts2.length) return false;
            
            // Cr√©er une signature pour chaque ensemble
            const sig1 = parts1.map(p => `${p.type}:${p.formula}:${p.coeff}`).sort().join('|');
            const sig2 = parts2.map(p => `${p.type}:${p.formula}:${p.coeff}`).sort().join('|');
            
            return sig1 === sig2;
        }

        // Fonction pour v√©rifier si une question a d√©j√† √©t√© pos√©e
        function isQuestionAsked(parts) {
            return askedQuestions.some(asked => arePartsEqual(asked, parts));
        }

        function generateQuestion() {
            if (currentMode === 1) return generateMode1Question();
            if (currentMode === 2) return generateMode2Question();
            if (currentMode === 3) return generateMode3Question();
        }

        // MODE 1: Formule ‚Üí Mod√®le
        function generateMode1Question() {
            const maxCoeff = getMaxCoefficient();
            let parts;
            let attempts = 0;
            const maxAttempts = 50;
            
            // G√©n√©rer une question unique
            do {
                parts = [];
                const numParts = Math.random() < 0.5 ? 1 : 2;
                
                for (let i = 0; i < numParts; i++) {
                    if (Math.random() < 0.7) {
                        // Mol√©cule
                        const molecules = Object.keys(MOLECULES);
                        const molecule = molecules[Math.floor(Math.random() * molecules.length)];
                        const coeff = Math.floor(Math.random() * maxCoeff) + 1;
                        parts.push({ type: 'molecule', formula: molecule, coeff });
                    } else {
                        // Atome isol√©
                        const atom = ATOMS[Math.floor(Math.random() * ATOMS.length)];
                        const coeff = Math.floor(Math.random() * maxCoeff) + 1;
                        parts.push({ type: 'atom', formula: atom, coeff });
                    }
                }
                attempts++;
            } while (isQuestionAsked(parts) && attempts < maxAttempts);
            
            // Ajouter √† l'historique
            askedQuestions.push(JSON.parse(JSON.stringify(parts)));
            
            return {
                parts,
                correctAnswer: 0
            };
        }

        function displayMode1Question(question) {
            const formula = question.parts.map(part => {
                const coeff = part.coeff > 1 ? part.coeff : '';
                return `${coeff}${part.formula}`;
            }).join(' + ');
            
            // G√©n√©rer 3 options uniques dont une correcte
            const options = [question.parts]; // Option correcte
            
            // G√©n√©rer 2 options incorrectes uniques
            let attempts = 0;
            const maxAttempts = 100;
            
            while (options.length < 3 && attempts < maxAttempts) {
                attempts++;
                const wrongOption = JSON.parse(JSON.stringify(question.parts));
                
                // Modifier al√©atoirement
                if (Math.random() < 0.5 && wrongOption.length > 0) {
                    // Changer un coefficient
                    const idx = Math.floor(Math.random() * wrongOption.length);
                    const change = Math.random() < 0.5 ? 1 : -1;
                    wrongOption[idx].coeff = Math.max(1, wrongOption[idx].coeff + change);
                } else if (wrongOption.length > 0) {
                    // Changer une mol√©cule/atome
                    const idx = Math.floor(Math.random() * wrongOption.length);
                    
                    if (Math.random() < 0.5) {
                        // Changer pour une mol√©cule
                        const molecules = Object.keys(MOLECULES);
                        let newMol;
                        do {
                            newMol = molecules[Math.floor(Math.random() * molecules.length)];
                        } while (newMol === wrongOption[idx].formula);
                        wrongOption[idx].formula = newMol;
                        wrongOption[idx].type = 'molecule';
                    } else {
                        // Changer pour un atome
                        let newAtom;
                        do {
                            newAtom = ATOMS[Math.floor(Math.random() * ATOMS.length)];
                        } while (newAtom === wrongOption[idx].formula);
                        wrongOption[idx].formula = newAtom;
                        wrongOption[idx].type = 'atom';
                    }
                }
                
                // V√©rifier que cette option n'existe pas d√©j√†
                const isDuplicate = options.some(opt => arePartsEqual(opt, wrongOption));
                
                if (!isDuplicate) {
                    options.push(wrongOption);
                }
            }
            
            // Si on n'a pas r√©ussi √† g√©n√©rer 3 options uniques, ajouter une option simple
            while (options.length < 3) {
                const simpleWrong = JSON.parse(JSON.stringify(question.parts));
                if (simpleWrong.length > 0) {
                    simpleWrong[0].coeff = (simpleWrong[0].coeff % getMaxCoefficient()) + 1;
                    
                    const isDuplicate = options.some(opt => arePartsEqual(opt, simpleWrong));
                    if (!isDuplicate) {
                        options.push(simpleWrong);
                    } else {
                        break; // √âviter une boucle infinie
                    }
                }
            }
            
            // M√©langer les options
            shuffleArray(options);
            question.correctAnswer = options.indexOf(question.parts);
            
            let html = `
                <div class="question">Quelle mod√©lisation correspond √† cette formule ?</div>
                <div class="formula">${formula}</div>
                <div class="options">
            `;
            
            options.forEach((option, idx) => {
                html += `<div class="option" onclick="selectOption(${idx})">`;
                html += renderMolecules(option);
                html += `</div>`;
            });
            
            html += `</div>`;
            
            document.getElementById('question-content').innerHTML = html;
            document.getElementById('submit-btn').style.display = 'inline-block';
        }

        // Ajuste la taille si beaucoup d‚Äôobjets √† afficher
        function computeScaleFromParts(parts) {
            const total = parts.reduce((s, p) => s + (p.coeff || 0), 0);
            if (total >= 16) return 0.6;
            if (total >= 10) return 0.75;
            if (total >= 6) return 0.85;
            return 1;
        }

        function renderMolecules(parts) {
            const scale = computeScaleFromParts(parts);
            let html = '<div class="molecule-display">';
            
            parts.forEach(part => {
                for (let i = 0; i < part.coeff; i++) {
                    const rot = (Math.random() - 0.5) * 10;
                    if (part.type === 'atom') {
                        html += `<div class="molecule" style="transform: rotate(${rot}deg) scale(${scale})">${renderAtom(part.formula)}</div>`;
                    } else {
                        html += renderMolecule(part.formula, scale);
                    }
                }
            });
            
            html += '</div>';
            return html;
        }

        function renderAtom(symbol, extraClass = '') {
            const extra = extraClass ? ` ${extraClass}` : '';
            return `<span class="atom atom-${symbol}${extra}"></span>`;
        }

        function renderMolecule(formula, scale = 1) {
            const rotation = (Math.random() - 0.5) * 10; // Rotation al√©atoire -5¬∞ √† +5¬∞
            
            // M√©thane CH‚ÇÑ - forme en +
            if (formula === 'CH‚ÇÑ') {
                return `
                    <div class="molecule molecule-ch4" style="transform: rotate(${rotation}deg) scale(${scale})">
                        ${renderAtom('H','h1')}
                        <span></span>
                        <span></span>
                        ${renderAtom('H','h2')}
                        ${renderAtom('C')}
                        ${renderAtom('H','h4')}
                        <span></span>
                        ${renderAtom('H','h3')}
                        <span></span>
                    </div>
                `;
            }
            
            // Eau H‚ÇÇO - forme en V
            if (formula === 'H‚ÇÇO') {
				return `
					<div class="molecule molecule-h2o" style="transform: rotate(${rotation}deg) scale(${scale})">
						${renderAtom('O')}
						${renderAtom('H','h1')}
						${renderAtom('H','h2')}
					</div>
				`;
			}

            
            // Dioxyde de carbone CO‚ÇÇ - lin√©aire O-C-O
            if (formula === 'CO‚ÇÇ') {
                return `
                    <div class="molecule molecule-co2" style="transform: rotate(${rotation}deg) scale(${scale})">
                        ${renderAtom('O')}
                        ${renderAtom('C')}
                        ${renderAtom('O')}
                    </div>
                `;
            }
            
            // Protoxyde d'azote N‚ÇÇO - lin√©aire N-N-O
            if (formula === 'N‚ÇÇO') {
                return `
                    <div class="molecule molecule-n2o" style="transform: rotate(${rotation}deg) scale(${scale})">
                        ${renderAtom('N')}
                        ${renderAtom('N')}
                        ${renderAtom('O')}
                    </div>
                `;
            }
            
            // Mol√©cules diatomiques (O‚ÇÇ, H‚ÇÇ, N‚ÇÇ) - lin√©aires
            const atoms = MOLECULES[formula].atoms;
            let html = `<div class="molecule molecule-linear" style="transform: rotate(${rotation}deg) scale(${scale})">`;
            
            for (let atom in atoms) {
                for (let i = 0; i < atoms[atom]; i++) {
                    html += renderAtom(atom);
                }
            }
            
            html += '</div>';
            return html;
        }

        // MODE 2: Compter les atomes (avec atomes isol√©s + mol√©cules)
        function generateMode2Question() {
            const maxCoeff = getMaxCoefficient();
            let parts;
            let attempts = 0;
            const maxAttempts = 60;

            do {
                parts = [];

                // Choisir 1 √† 3 types diff√©rents (atomes et/ou mol√©cules)
                const numTypes = 1 + Math.floor(Math.random() * 3); // 1..3
                const moleculeKeys = Object.keys(MOLECULES);
                const chosen = [];

                while (chosen.length < numTypes) {
                    const pickAtom = Math.random() < 0.35; // ~35% atome isol√©
                    const candidate = pickAtom
                        ? { type: 'atom', formula: ATOMS[Math.floor(Math.random() * ATOMS.length)] }
                        : { type: 'molecule', formula: moleculeKeys[Math.floor(Math.random() * moleculeKeys.length)] };

                    const id = candidate.type + ':' + candidate.formula;
                    if (!chosen.some(x => (x.type + ':' + x.formula) === id)) chosen.push(candidate);
                }

                chosen.forEach(item => {
                    const coeff = Math.floor(Math.random() * maxCoeff) + 1;
                    parts.push({ type: item.type, formula: item.formula, coeff });
                });

                attempts++;
            } while (isQuestionAsked(parts) && attempts < maxAttempts);

            askedQuestions.push(JSON.parse(JSON.stringify(parts)));

            // Calculer le total de chaque type d'atome
            const atomCounts = {};
            parts.forEach(part => {
                if (part.type === 'atom') {
                    atomCounts[part.formula] = (atomCounts[part.formula] || 0) + part.coeff;
                } else {
                    const atoms = MOLECULES[part.formula].atoms;
                    for (let atom in atoms) {
                        atomCounts[atom] = (atomCounts[atom] || 0) + atoms[atom] * part.coeff;
                    }
                }
            });

            const availableAtoms = Object.keys(atomCounts);
            const atomToCount = availableAtoms[Math.floor(Math.random() * availableAtoms.length)];

            return {
                parts,
                atomToCount,
                correctAnswer: atomCounts[atomToCount],
                allCounts: atomCounts
            };
        }

        function displayMode2Question(question) {
            const formula = question.parts.map(part => {
                const coeff = part.coeff > 1 ? part.coeff : '';
                return `${coeff}${part.formula}`;
            }).join(' + ');

            const html = `
                <div class="question">Combien y a-t-il d'atomes ${atomPhrase(question.atomToCount)} ?</div>
                <div class="formula">${formula}</div>
                <input type="number" id="answer-input" class="input-answer" min="0" placeholder="?">
            `;
            
            document.getElementById('question-content').innerHTML = html;
            document.getElementById('submit-btn').style.display = 'inline-block';
            
            document.getElementById('answer-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkAnswer();
            });
        }

        // MODE 3: Atome ou Mol√©cule ?
        function generateMode3Question() {
            const useVisual = Math.random() < 0.5;
            const isAtom = Math.random() < 0.5;
            
            if (isAtom) {
                const atom = ATOMS_MODE3[Math.floor(Math.random() * ATOMS_MODE3.length)];
                return {
                    type: 'atom',
                    formula: atom,
                    useVisual,
                    correctAnswer: 'atome'
                };
            } else {
                let formula;
                if (Math.random() < 0.3) {
                    formula = MOLECULE_MODE3; // CO
                } else {
                    const molecules = Object.keys(MOLECULES);
                    formula = molecules[Math.floor(Math.random() * molecules.length)];
                }
                return {
                    type: 'molecule',
                    formula,
                    useVisual,
                    correctAnswer: 'mol√©cule'
                };
            }
        }

        function displayMode3Question(question) {
            let content = '<div class="question">Est-ce un atome ou une mol√©cule ?</div>';
            
            if (question.useVisual) {
                content += '<div class="molecule-display">';
                if (question.type === 'atom') {
                    content += `<div class="molecule">${renderAtom(question.formula)}</div>`;
                } else {
                    if (question.formula === MOLECULE_MODE3) {
                        content += `<div class="molecule molecule-linear">${renderAtom('C')}${renderAtom('O')}</div>`;
                    } else {
                        content += renderMolecule(question.formula, 1);
                    }
                }
                content += '</div>';
            } else {
                content += `<div class="formula">${question.formula}</div>`;
            }
            
            content += `
                <div class="options">
                    <div class="option" onclick="selectOption(0)">Atome</div>
                    <div class="option" onclick="selectOption(1)">Mol√©cule</div>
                </div>
            `;
            
            document.getElementById('question-content').innerHTML = content;
            document.getElementById('submit-btn').style.display = 'inline-block';
        }

        let selectedOption = null;

        function selectOption(index) {
            if (answered) return;
            
            selectedOption = index;
            const options = document.querySelectorAll('.option');
            options.forEach((opt, idx) => {
                opt.classList.remove('selected');
                if (idx === index) opt.classList.add('selected');
            });
        }

        function checkAnswer() {
            if (answered) return;
            answered = true;
            
            let isCorrect = false;
            let userAnswer;
            
            if (currentMode === 1) {
                userAnswer = selectedOption;
                isCorrect = userAnswer === currentQuestion.correctAnswer;
            } else if (currentMode === 2) {
                userAnswer = parseInt(document.getElementById('answer-input').value);
                isCorrect = userAnswer === currentQuestion.correctAnswer;
            } else if (currentMode === 3) {
                const answers = ['atome', 'mol√©cule'];
                userAnswer = answers[selectedOption];
                isCorrect = userAnswer === currentQuestion.correctAnswer;
            }
            
            const feedback = document.getElementById('feedback');
            feedback.classList.add('show');
            
            if (isCorrect) {
                correctAnswers++;
                feedback.className = 'feedback show correct';
                feedback.innerHTML = '‚úÖ <strong>Bravo !</strong> C\'est la bonne r√©ponse !';
                
                if (currentMode === 1) {
                    const options = document.querySelectorAll('.option');
                    options[currentQuestion.correctAnswer].classList.add('correct');
                }
            } else {
                feedback.className = 'feedback show incorrect';
                feedback.innerHTML = '‚ùå <strong>Ce n\'est pas la bonne r√©ponse.</strong>';
                
                // Afficher la correction
                let correction = '<div class="correction"><h3>üìö CORRECTION</h3>';
                
                if (currentMode === 1) {
                    const options = document.querySelectorAll('.option');
                    if (selectedOption !== null) {
                        options[selectedOption].classList.add('incorrect');
                    }
                    options[currentQuestion.correctAnswer].classList.add('correct');
                    correction += '<p>La bonne mod√©lisation est celle qui est maintenant entour√©e en vert.</p>';
                    correction += '<p><strong>Astuce :</strong> Compte bien le nombre de chaque type d\'atome dans la formule et v√©rifie que la mod√©lisation correspond.</p>';
                } else if (currentMode === 2) {
                    correction += `<p>La bonne r√©ponse est : <strong>${currentQuestion.correctAnswer}</strong> atome${currentQuestion.correctAnswer > 1 ? 's' : ''} ${atomPhrase(currentQuestion.atomToCount)}.</p>`;
                    correction += '<p><strong>Explication :</strong></p>';
                    
                    currentQuestion.parts.forEach(part => {
                        const coeff = part.coeff > 1 ? part.coeff : '';
                        const formula = `${coeff}${part.formula}`;
                        
                        if (part.type === 'atom') {
                            if (part.formula === currentQuestion.atomToCount) {
                                correction += `<p>‚Ä¢ ${formula} contient ${part.coeff} atome${part.coeff > 1 ? 's' : ''} ${atomPhrase(currentQuestion.atomToCount)}</p>`;
                            }
                        } else {
                            const atoms = MOLECULES[part.formula].atoms;
                            if (atoms[currentQuestion.atomToCount]) {
                                const count = atoms[currentQuestion.atomToCount] * part.coeff;
                                correction += `<p>‚Ä¢ ${formula} contient ${atoms[currentQuestion.atomToCount]} √ó ${part.coeff} = ${count} atome${count > 1 ? 's' : ''} ${atomPhrase(currentQuestion.atomToCount)}</p>`;
                            }
                        }
                    });
                    
                    correction += `<p><strong>Total : ${currentQuestion.correctAnswer} atome${currentQuestion.correctAnswer > 1 ? 's' : ''} ${atomPhrase(currentQuestion.atomToCount)}</strong></p>`;
                } else if (currentMode === 3) {
                    const options = document.querySelectorAll('.option');
                    const correctIdx = currentQuestion.correctAnswer === 'atome' ? 0 : 1;
                    if (selectedOption !== null) {
                        options[selectedOption].classList.add('incorrect');
                    }
                    options[correctIdx].classList.add('correct');
                    
                    if (currentQuestion.correctAnswer === 'atome') {
                        correction += `<p>C'est un <strong>atome</strong> car ${currentQuestion.formula} est un √©l√©ment chimique unique.</p>`;
                        correction += '<p><strong>Rappel :</strong> Un atome est la plus petite partie d\'un √©l√©ment chimique.</p>';
                    } else {
                        correction += `<p>C'est une <strong>mol√©cule</strong> car ${currentQuestion.formula} est form√©e de plusieurs atomes li√©s entre eux.</p>`;
                        correction += '<p><strong>Rappel :</strong> Une mol√©cule est un assemblage d\'au moins 2 atomes.</p>';
                    }
                }
                
                correction += '</div>';
                feedback.innerHTML += correction;
            }
            
            document.getElementById('submit-btn').style.display = 'none';
            document.getElementById('next-btn').style.display = 'inline-block';
            
            updateProgress();
        }

        function nextQuestion() {
            questionNumber++;
            answered = false;
            selectedOption = null;
            
            if (questionNumber > 10) {
                endGame();
                return;
            }
            
            document.getElementById('question-number').textContent = questionNumber;
            document.getElementById('feedback').classList.remove('show');
            document.getElementById('submit-btn').style.display = 'none';
            document.getElementById('next-btn').style.display = 'none';
            
            currentQuestion = generateQuestion();
            
            if (currentMode === 1) displayMode1Question(currentQuestion);
            else if (currentMode === 2) displayMode2Question(currentQuestion);
            else if (currentMode === 3) displayMode3Question(currentQuestion);
        }

        function updateProgress() {
            const percentage = Math.round((correctAnswers / questionNumber) * 100);
            const progressFill = document.getElementById('progress-fill');
            progressFill.style.width = percentage + '%';
            progressFill.textContent = percentage + '%';
        }

        function endGame() {
            const percentage = Math.round((correctAnswers / 10) * 100);

            // D√©blocage Expert : on retient l'√©tat AVANT (sinon le message ne s'affiche jamais)
            const wasUnlocked = isExpertUnlocked(currentMode);
            if (currentLevel === 'medium' && percentage >= 70 && !wasUnlocked) {
                unlockExpertLevel(currentMode);
            }
            
            let message = `
                <div class="question">üéâ Partie termin√©e !</div>
                <div style="text-align: center; font-size: 1.3em; margin: 30px 0;">
                    <p style="margin: 15px 0;"><strong>Score final :</strong> ${correctAnswers}/10 (${percentage}%)</p>
            `;
            
            if (percentage === 100) {
                message += '<p style="color: #48bb78; font-size: 1.5em;">üèÜ Parfait ! Excellent travail !</p>';
            } else if (percentage >= 70) {
                message += '<p style="color: #48bb78;">‚ú® Tr√®s bien ! Continue comme √ßa !</p>';
                if (currentLevel === 'medium' && percentage >= 70 && !wasUnlocked) {
                    message += '<p style="color: #667eea; font-weight: bold; margin-top: 20px;">üîì Tu as d√©bloqu√© le niveau Expert !</p>';
                }
            } else if (percentage >= 50) {
                message += '<p style="color: #f59e0b;">üëç Pas mal ! Tu peux encore progresser !</p>';
            } else {
                message += '<p style="color: #f56565;">üí™ Continue √† t\'entra√Æner, tu vas y arriver !</p>';
            }
            
            message += '</div>';
            
            document.getElementById('question-content').innerHTML = message;
            document.getElementById('next-btn').style.display = 'none';
        }

        function quitGame() {
            document.getElementById('game-area').classList.remove('active');
            document.getElementById('menu').style.display = 'block';
            document.getElementById('level-selector').style.display = 'none';
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
    </script>
</body>
</html>
